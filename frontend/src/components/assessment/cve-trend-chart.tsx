'use client';

import { Card } from '@/components/ui/card';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Area, AreaChart } from 'recharts';
import { TrendingDown, TrendingUp, Minus } from 'lucide-react';

interface CVETrendData {
  month: string;
  count: number;
}

interface CVETrendChartProps {
  data: CVETrendData[];
  title?: string;
  totalCVEs?: number;
}

export function CVETrendChart({
  data,
  title = 'Vulnerability Trends',
  totalCVEs,
}: CVETrendChartProps) {
  // Calculate trend
  const firstHalf = data.slice(0, 6).reduce((sum, d) => sum + d.count, 0);
  const secondHalf = data.slice(6).reduce((sum, d) => sum + d.count, 0);
  const trend = secondHalf - firstHalf;
  
  const getTrendInfo = () => {
    if (trend > 2) return { icon: TrendingUp, text: 'Increasing', color: 'text-red-500' };
    if (trend < -2) return { icon: TrendingDown, text: 'Decreasing', color: 'text-green-500' };
    return { icon: Minus, text: 'Stable', color: 'text-yellow-500' };
  };

  const trendInfo = getTrendInfo();
  const TrendIcon = trendInfo.icon;

  // Get max value for Y axis
  const maxCount = Math.max(...data.map(d => d.count));
  const yAxisMax = Math.ceil(maxCount * 1.2);

  // Format month labels
  const formatMonth = (month: string) => {
    const [year, monthNum] = month.split('-');
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return monthNames[parseInt(monthNum) - 1];
  };

  return (
    <Card className="p-6">
      <div className="space-y-4">
        {/* Header */}
        <div className="flex items-start justify-between">
          <div>
            <h3 className="text-lg font-semibold">{title}</h3>
            <p className="text-sm text-muted-foreground">
              CVE discoveries over the last 12 months
            </p>
          </div>
          <div className="flex items-center gap-2">
            <div className={`flex items-center gap-1 ${trendInfo.color}`}>
              <TrendIcon className="w-4 h-4" />
              <span className="text-sm font-medium">{trendInfo.text}</span>
            </div>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-3 gap-4">
          <div className="p-3 rounded-lg bg-muted/50">
            <div className="text-2xl font-bold">{totalCVEs || data.reduce((s, d) => s + d.count, 0)}</div>
            <div className="text-xs text-muted-foreground">Total CVEs</div>
          </div>
          <div className="p-3 rounded-lg bg-muted/50">
            <div className="text-2xl font-bold">{(data.reduce((s, d) => s + d.count, 0) / 12).toFixed(1)}</div>
            <div className="text-xs text-muted-foreground">Avg/Month</div>
          </div>
          <div className="p-3 rounded-lg bg-muted/50">
            <div className="text-2xl font-bold">{data[data.length - 1]?.count || 0}</div>
            <div className="text-xs text-muted-foreground">Last Month</div>
          </div>
        </div>

        {/* Chart */}
        <div className="w-full h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={data}>
              <defs>
                <linearGradient id="colorCount" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3}/>
                  <stop offset="95%" stopColor="#ef4444" stopOpacity={0}/>
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
              <XAxis
                dataKey="month"
                tickFormatter={formatMonth}
                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}
                stroke="hsl(var(--border))"
              />
              <YAxis
                domain={[0, yAxisMax]}
                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}
                stroke="hsl(var(--border))"
              />
              <Tooltip
                contentStyle={{
                  backgroundColor: 'hsl(var(--popover))',
                  border: '1px solid hsl(var(--border))',
                  borderRadius: '8px',
                }}
                labelStyle={{ color: 'hsl(var(--popover-foreground))' }}
                formatter={(value: number) => [`${value} CVEs`, 'Count']}
                labelFormatter={(label) => formatMonth(label)}
              />
              <Area
                type="monotone"
                dataKey="count"
                stroke="#ef4444"
                strokeWidth={2}
                fill="url(#colorCount)"
                animationDuration={1500}
              />
            </AreaChart>
          </ResponsiveContainer>
        </div>

        {/* Insight */}
        <div className="p-3 rounded-lg bg-muted/30 border border-border/50">
          <p className="text-sm text-muted-foreground">
            {trend > 2 && (
              <span>‚ö†Ô∏è CVE reports are <strong className="text-red-500">increasing</strong>. Monitor patch releases closely.</span>
            )}
            {trend < -2 && (
              <span>‚úÖ CVE reports are <strong className="text-green-500">decreasing</strong>. Security posture improving.</span>
            )}
            {Math.abs(trend) <= 2 && (
              <span>üìä CVE reports remain <strong className="text-yellow-500">stable</strong>. Continue monitoring.</span>
            )}
          </p>
        </div>
      </div>
    </Card>
  );
}
